image: python:3.11

stages:
  - lint
  - test

variables:
  UV_INSTALL_DIR: "$CI_PROJECT_DIR/.uv"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .venv/
    - .uv/

before_script:
  - python -m pip install --upgrade pip
  - pip install uv
  - uv venv
  - uv pip install -e .[dev,test]

lint:
  stage: lint
  script:
    - uv run black --check src/ tests/
    - uv run ruff check src/ tests/
    - uv run mypy src/
  allow_failure: false

test:
  stage: test
  script:
    - uv run pytest --cov=pulseguard --cov-report=xml --cov-report=term --cov-report=html --junitxml=junit.xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - junit.xml
      - coverage.xml
      - htmlcov/
