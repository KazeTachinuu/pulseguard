image: python:3.11

stages:
  - lint
  - test

# Cache based on dependencies file for better invalidation
cache:
  key:
    files:
      - pyproject.toml
  paths:
    - .venv/

before_script:
  - python -m pip install --upgrade pip
  - pip install uv
  - uv venv
  - source .venv/bin/activate
  - uv pip install -e .[dev,test]

# Run all lint checks in parallel - don't let one block the others
lint:black:
  stage: lint
  script:
    - uv run black --check src/ tests/

lint:ruff:
  stage: lint
  script:
    - uv run ruff check src/ tests/

lint:mypy:
  stage: lint
  script:
    - uv run mypy src/

test:
  stage: test
  script:
    # Fixed: using src/pulseguard to match pyproject.toml coverage source
    - uv run pytest --cov=src/pulseguard --cov-report=xml --cov-report=term --cov-report=html --cov-fail-under=70 --junitxml=junit.xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - junit.xml
      - coverage.xml
      - htmlcov/
