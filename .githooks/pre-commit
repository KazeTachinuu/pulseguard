#!/bin/bash
# Pre-commit hook: Auto-format and validate code before committing

set -e  # Exit on any error

echo "ğŸ” Running pre-commit checks..."

# Get list of Python files being committed
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$FILES" ]; then
    echo "âœ“ No Python files to check."
    exit 0
fi

echo "ğŸ“ Files to check:"
echo "$FILES" | sed 's/^/  - /'
echo ""

# 1. Auto-format with black
echo "ğŸ¨ Auto-formatting with black..."
if ! uv run black "$FILES"; then
    echo "âŒ Black formatting failed!"
    exit 1
fi

# 2. Auto-fix code quality issues with ruff
echo "ğŸ”§ Fixing code quality issues with ruff..."
if ! uv run ruff check --fix "$FILES"; then
    echo "âŒ Ruff check failed - some issues couldn't be auto-fixed!"
    echo "ğŸ’¡ Hint: Run 'uv run ruff check $FILES' to see details"
    exit 1
fi

# 3. Run mypy on source files only (not tests)
SRC_FILES=$(echo "$FILES" | grep '^src/' || true)
if [ -n "$SRC_FILES" ]; then
    echo "ğŸ” Type checking with mypy..."
    if ! uv run mypy "$SRC_FILES"; then
        echo "âŒ Type checking failed!"
        echo "ğŸ’¡ Hint: Fix type errors or use '# type: ignore' if necessary"
        exit 1
    fi
fi

# Re-stage the formatted files
git add "$FILES"

echo ""
echo "âœ… All pre-commit checks passed!"
exit 0
