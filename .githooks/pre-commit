#!/bin/bash
# Pre-commit hook: Auto-format and validate code before committing

set -e

echo "ğŸ” Running pre-commit checks..."

# Get list of Python files being committed (using array)
mapfile -t FILES < <(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ ${#FILES[@]} -eq 0 ]; then
    echo "âœ“ No Python files to check."
    exit 0
fi

echo "ğŸ“ Files to check:"
printf '  - %s\n' "${FILES[@]}"
echo ""

# 1. Auto-format with black
echo "ğŸ¨ Auto-formatting with black..."
if ! uv run black "${FILES[@]}"; then
    echo "âŒ Black formatting failed!"
    exit 1
fi

# 2. Auto-fix code quality issues with ruff
echo "ğŸ”§ Fixing code quality issues with ruff..."
if ! uv run ruff check --fix "${FILES[@]}"; then
    echo "âŒ Ruff check failed!"
    exit 1
fi

# 3. Run mypy on source files only
mapfile -t SRC_FILES < <(printf '%s\n' "${FILES[@]}" | grep '^src/' || true)
if [ ${#SRC_FILES[@]} -gt 0 ]; then
    echo "ğŸ” Type checking with mypy..."
    if ! uv run mypy "${SRC_FILES[@]}"; then
        echo "âŒ Type checking failed!"
        exit 1
    fi
fi

# Re-stage the formatted files
git add "${FILES[@]}"

echo ""
echo "âœ… All pre-commit checks passed!"
exit 0
